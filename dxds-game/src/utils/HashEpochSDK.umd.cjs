(function(c,d){typeof exports=="object"&&typeof module<"u"?module.exports=d():typeof define=="function"&&define.amd?define(d):(c=typeof globalThis<"u"?globalThis:c||self,c.HashEpochSDK=d())})(this,function(){"use strict";var D=Object.defineProperty;var H=(c,d,g)=>d in c?D(c,d,{enumerable:!0,configurable:!0,writable:!0,value:g}):c[d]=g;var m=(c,d,g)=>H(c,typeof d!="symbol"?d+"":d,g);var c={exports:{}},d;function g(){if(d)return c.exports;d=1;var h=typeof Reflect=="object"?Reflect:null,l=h&&typeof h.apply=="function"?h.apply:function(e,n,r){return Function.prototype.apply.call(e,n,r)},u;h&&typeof h.ownKeys=="function"?u=h.ownKeys:Object.getOwnPropertySymbols?u=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:u=function(e){return Object.getOwnPropertyNames(e)};function a(t){console&&console.warn&&console.warn(t)}var v=Number.isNaN||function(e){return e!==e};function o(){o.init.call(this)}c.exports=o,c.exports.once=W,o.EventEmitter=o,o.prototype._events=void 0,o.prototype._eventsCount=0,o.prototype._maxListeners=void 0;var L=10;function y(t){if(typeof t!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t)}Object.defineProperty(o,"defaultMaxListeners",{enumerable:!0,get:function(){return L},set:function(t){if(typeof t!="number"||t<0||v(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");L=t}}),o.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},o.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||v(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function _(t){return t._maxListeners===void 0?o.defaultMaxListeners:t._maxListeners}o.prototype.getMaxListeners=function(){return _(this)},o.prototype.emit=function(e){for(var n=[],r=1;r<arguments.length;r++)n.push(arguments[r]);var s=e==="error",f=this._events;if(f!==void 0)s=s&&f.error===void 0;else if(!s)return!1;if(s){var i;if(n.length>0&&(i=n[0]),i instanceof Error)throw i;var p=new Error("Unhandled error."+(i?" ("+i.message+")":""));throw p.context=i,p}var x=f[e];if(x===void 0)return!1;if(typeof x=="function")l(x,this,n);else for(var j=x.length,k=M(x,j),r=0;r<j;++r)l(k[r],this,n);return!0};function b(t,e,n,r){var s,f,i;if(y(n),f=t._events,f===void 0?(f=t._events=Object.create(null),t._eventsCount=0):(f.newListener!==void 0&&(t.emit("newListener",e,n.listener?n.listener:n),f=t._events),i=f[e]),i===void 0)i=f[e]=n,++t._eventsCount;else if(typeof i=="function"?i=f[e]=r?[n,i]:[i,n]:r?i.unshift(n):i.push(n),s=_(t),s>0&&i.length>s&&!i.warned){i.warned=!0;var p=new Error("Possible EventEmitter memory leak detected. "+i.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");p.name="MaxListenersExceededWarning",p.emitter=t,p.type=e,p.count=i.length,a(p)}return t}o.prototype.addListener=function(e,n){return b(this,e,n,!1)},o.prototype.on=o.prototype.addListener,o.prototype.prependListener=function(e,n){return b(this,e,n,!0)};function F(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function R(t,e,n){var r={fired:!1,wrapFn:void 0,target:t,type:e,listener:n},s=F.bind(r);return s.listener=n,r.wrapFn=s,s}o.prototype.once=function(e,n){return y(n),this.on(e,R(this,e,n)),this},o.prototype.prependOnceListener=function(e,n){return y(n),this.prependListener(e,R(this,e,n)),this},o.prototype.removeListener=function(e,n){var r,s,f,i,p;if(y(n),s=this._events,s===void 0)return this;if(r=s[e],r===void 0)return this;if(r===n||r.listener===n)--this._eventsCount===0?this._events=Object.create(null):(delete s[e],s.removeListener&&this.emit("removeListener",e,r.listener||n));else if(typeof r!="function"){for(f=-1,i=r.length-1;i>=0;i--)if(r[i]===n||r[i].listener===n){p=r[i].listener,f=i;break}if(f<0)return this;f===0?r.shift():K(r,f),r.length===1&&(s[e]=r[0]),s.removeListener!==void 0&&this.emit("removeListener",e,p||n)}return this},o.prototype.off=o.prototype.removeListener,o.prototype.removeAllListeners=function(e){var n,r,s;if(r=this._events,r===void 0)return this;if(r.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):r[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete r[e]),this;if(arguments.length===0){var f=Object.keys(r),i;for(s=0;s<f.length;++s)i=f[s],i!=="removeListener"&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(n=r[e],typeof n=="function")this.removeListener(e,n);else if(n!==void 0)for(s=n.length-1;s>=0;s--)this.removeListener(e,n[s]);return this};function O(t,e,n){var r=t._events;if(r===void 0)return[];var s=r[e];return s===void 0?[]:typeof s=="function"?n?[s.listener||s]:[s]:n?T(s):M(s,s.length)}o.prototype.listeners=function(e){return O(this,e,!0)},o.prototype.rawListeners=function(e){return O(this,e,!1)},o.listenerCount=function(t,e){return typeof t.listenerCount=="function"?t.listenerCount(e):A.call(t,e)},o.prototype.listenerCount=A;function A(t){var e=this._events;if(e!==void 0){var n=e[t];if(typeof n=="function")return 1;if(n!==void 0)return n.length}return 0}o.prototype.eventNames=function(){return this._eventsCount>0?u(this._events):[]};function M(t,e){for(var n=new Array(e),r=0;r<e;++r)n[r]=t[r];return n}function K(t,e){for(;e+1<t.length;e++)t[e]=t[e+1];t.pop()}function T(t){for(var e=new Array(t.length),n=0;n<e.length;++n)e[n]=t[n].listener||t[n];return e}function W(t,e){return new Promise(function(n,r){function s(i){t.removeListener(e,f),r(i)}function f(){typeof t.removeListener=="function"&&t.removeListener("error",s),n([].slice.call(arguments))}C(t,e,f,{once:!0}),e!=="error"&&U(t,s,{once:!0})})}function U(t,e,n){typeof t.on=="function"&&C(t,"error",e,n)}function C(t,e,n,r){if(typeof t.on=="function")r.once?t.once(e,n):t.on(e,n);else if(typeof t.addEventListener=="function")t.addEventListener(e,function s(f){r.once&&t.removeEventListener(e,s),n(f)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof t)}return c.exports}var E=g();const w={API_FAILURE:1001};class N extends Error{constructor(u,a){super(u);m(this,"code");this.name="SDKError",this.code=a||w.API_FAILURE}toJSON(){return{code:this.code,message:this.message}}}function P(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,h=>{const l=Math.random()*16|0;return(h==="x"?l:l&3|8).toString(16)})}function q(h,l){return l?(Array.isArray(l)?l:[l]).some(a=>!!(a==="*"||a===h||a.startsWith("*.")&&h.endsWith(a.slice(1)))):!1}class I extends E.EventEmitter{constructor({targetWindow:u,allowedOrigins:a}){super();m(this,"targetWindow");m(this,"allowedOrigins");m(this,"pendingRequests");this.targetWindow=u,this.allowedOrigins=a,this.pendingRequests=new Map,this._bindMessageListener()}_bindMessageListener(){window.addEventListener("message",this._handleMessage.bind(this))}_handleMessage(u){if(!q(u.origin,this.allowedOrigins))return;const{id:a,type:v,data:o,error:L}=u.data;if(v==="response"&&this.pendingRequests.has(a)){const{resolve:y,reject:_}=this.pendingRequests.get(a);this.pendingRequests.delete(a),L?_(L):y(o)}else v=="event"&&(console.log("event",o),this._handleSystemEvent(o))}_handleSystemEvent(u){switch(u.type){case"login":this.emit("login",u.data);break;case"logout":this.emit("logout");break;case"assetUpdate":this.emit("assetUpdate",u.data);break;default:this.emit("unhandledEvent",u)}}async request(u){const a=P();return new Promise((v,o)=>{this.pendingRequests.set(a,{resolve:v,reject:o}),this.targetWindow.postMessage({type:"request",id:a,payload:u,target:"hashgame-sdk"},"*")})}}class S extends E.EventEmitter{constructor(u){super();m(this,"core");m(this,"ready",!1);this.core=new I(u),this._init(),this._initEventForwarding()}on(u,a){return this.core.on(u,a),this}_initEventForwarding(){this.core.on("*",(u,a)=>{this.emit(u,a)})}_init(){this.core.on("ready",()=>this._handleReady()),this.core.on("error",u=>this._handleError(u))}async call(u,a){try{return await this.core.request({method:u,params:a})}catch(v){throw new N(v.message,w.API_FAILURE)}}_handleReady(){this.ready=!0,console.log("initialize success!")}_handleError(u){console.log("initialize error",u)}}return S});
